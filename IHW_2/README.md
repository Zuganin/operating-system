# Отчёт по лабораторной работе

## ФИО и группа

**Исполнитель:** Зенин Вадим Вадимович  
**Группа:** БПИ237

---

## Номер варианта и условие задачи

**Вариант:** 34

**Условие задачи:**  
Реализовать консольное приложение, в котором единый родительский процесс запускает заданное количество дочерних процессов. Каждый дочерний процесс моделирует поведение читателя в библиотеке, который может взять от 1 до 3 книг, читать их и возвращать по одной. Если нужной книги нет в наличии — читатель ожидает её. Возврат книги сопровождается уведомлением библиотекаря, который информирует всех ожидающих о её доступности.

---

## Сценарий решаемой задачи

Модель отражает взаимодействие читателей с библиотекой:

- **Родительский процесс** — инициализирует библиотеку, запускает читателей и библиотекаря.
- **Дочерние процессы** — реализуют поведение читателей:
  - Каждый читатель выбирает 1–3 случайные книги.
  - Если книга свободна — читатель берёт её и сразу начинает чтение.
  - Если книга занята — читатель ожидает уведомления от библиотекаря.
  - После чтения книга возвращается в библиотеку и становится доступной другим.
- **Процесс библиотекаря** — опрашивает очередь возвратов и уведомляет ожидающих читателей о доступных книгах.

---

# 4-5
## Схема взаимодействия процессов

Для реализации взаимодействия между процессами выбрана схема **a**:

- **Именованные POSIX семафоры** — используются для синхронизации доступа к книгам и очереди возвратов.
- **Разделяемая память (POSIX `shm_open`)** — хранит:
  - массив доступных книг;
  - очередь возвратов;
  - указатели `head` и `tail` для кольцевой очереди.

Объекты синхронизации:

- `sem_book_mutex[i]` — семафор для каждой книги, обеспечивает взаимное исключение при доступе к конкретной книге;
- `sem_books[i]` — семафоры ожидания, на которые подписываются читатели, если книга занята;
- `sem_notify` — семафор-уведомитель от читателя библиотекарю при возврате книги;
- `sem_mutex_queue` — защита кольцевой очереди возвратов.

---

## Обработка завершения

Реализованы два варианта завершения:

1. **Нормальное завершение**: после завершения всех дочерних процессов происходит очистка ресурсов.
2. **Завершение по сигналу (например, Ctrl+C)**:
   - Обрабатывается сигнал `SIGINT`.
   - Останавливаются все процессы.
   - Удаляются все созданные семафоры и разделяемая память.

---

## Очистка ресурсов

В функции `cleanup_and_exit()` предусмотрено:

- Удаление сегмента разделяемой памяти через `shm_unlink`.
- Освобождение всех POSIX семафоров через `sem_destroy`.
- Завершение процесса с кодом возврата.

---

## Пример запуска и результаты работы

Пример вывода:
```
[Читатель 1] хочет прочитать 1 книг(-и)
[Читатель 1] взял книгу 1
[Читатель 1] читает книгу 1 2 дней
[Читатель 2] хочет прочитать 2 книг(-и)
[Читатель 2] взял книгу 2
[Читатель 2] читает книгу 2 2 дней
[Читатель 2] вернул книгу 2
[Читатель 1] вернул книгу 1
[Библиотекарь] уведомляю читателя о книге 2
[Библиотекарь] уведомляю читателя о книге 1
[Читатель 2] взял книгу 1
[Читатель 2] читает книгу 1 1 дней
[Читатель 2] вернул книгу 1
```
Также происходит корректная обработка `SIGINT`:
```
[Читатель 1] хочет прочитать 2 книг(-и)
[Читатель 1] взял книгу 49
[Читатель 1] читает книгу 49 2 дней
[Читатель 2] хочет прочитать 3 книг(-и)
[Читатель 2] взял книгу 14
[Читатель 2] читает книгу 14 1 дней
[Читатель 3] хочет прочитать 1 книг(-и)
[Читатель 3] взял книгу 31
[Читатель 3] читает книгу 31 2 дней
[Читатель 4] хочет прочитать 2 книг(-и)
[Читатель 4] взял книгу 48
[Читатель 4] читает книгу 48 1 дней
[Читатель 5] хочет прочитать 3 книг(-и)
[Читатель 5] взял книгу 13
[Читатель 5] читает книгу 13 2 дней
[Читатель 6] хочет прочитать 1 книг(-и)
[Читатель 6] взял книгу 11
[Читатель 6] читает книгу 11 2 дней
[Читатель 7] хочет прочитать 2 книг(-и)
[Читатель 7] взял книгу 28
[Читатель 7] читает книгу 28 1 дней
[Читатель 8] хочет прочитать 3 книг(-и)
[Читатель 8] взял книгу 45
[Читатель 8] читает книгу 45 1 дней
[Читатель 9] хочет прочитать 1 книг(-и)
[Читатель 9] взял книгу 10
[Читатель 9] читает книгу 10 1 дней
[Читатель 10] хочет прочитать 2 книг(-и)
[Читатель 10] взял книгу 4
[Читатель 10] читает книгу 4 2 дней
[Читатель 2] вернул книгу 14
[Библиотекарь] уведомляю читателя о книге 14
[Читатель 4] вернул книгу 48
[Библиотекарь] уведомляю читателя о книге 48
[Читатель 7] вернул книгу 28
[Читатель 9] вернул книгу 10
[Библиотекарь] уведомляю читателя о книге 28
[Библиотекарь] уведомляю читателя о книге 10
[Читатель 8] вернул книгу 45
[Библиотекарь] уведомляю читателя о книге 45
^C%      
```

---

# 6-5
## Схема взаимодействия процессов
Структура разделяемой памяти (`shm_t`)

```c
typedef struct {
    int head, tail;
    int queue[MAXQ];
    int books[N];
    int done;
    sem_t mutex_queue;
    sem_t notify;
    sem_t book_mutex[N];
    sem_t book_sem[N];
} shm_t;
```

- `books[N]` — наличие книг (1 — доступна, 0 — занята);
- `queue[MAXQ]` — очередь из индексов возвращённых книг;
- `mutex_queue` — семафор для доступа к очереди;
- `notify` — семафор для оповещения библиотекаря;
- `book_mutex[N]` — мьютексы для защиты состояния книг;
- `book_sem[N]` — семафоры ожидания книг.

---

## Изменения и особенности реализации

- Именованные семафоры были заменены на **неименованные**, инициализируемые через `sem_init(..., pshared=1, ...)`;
- Семафоры и переменные состояния помещены **внутрь общей памяти**, доступной всем процессам;
- Использованы обёртки `safe_sem_wait` и `safe_sem_post` для безопасной работы при прерываниях (`EINTR`);
- Добавлена обработка `SIGINT` для корректного завершения работы и очистки ресурсов;

---

## Очистка ресурсов

Очистка происходит также с помощью функции `cleanup_and_exit()`:

---

## Пример запуска и результаты работы
```
[Читатель 1] хочет прочитать 1 книг(-и)
[Читатель 2] хочет прочитать 3 книг(-и)
[Читатель 1] взял книгу 2
[Читатель 2] взял книгу 0
[Читатель 1] читает книгу 2 2 дней
[Читатель 2] читает книгу 0 2 дней
[Читатель 2] вернул книгу 0
[Читатель 1] вернул книгу 2
[Библиотекарь] уведомляю читателя о книге 2
[Библиотекарь] уведомляю читателя о книге 0
[Читатель 2] взял книгу 2
[Читатель 2] читает книгу 2 1 дней
[Читатель 2] вернул книгу 2
[Библиотекарь] уведомляю читателя о книге 2
[Читатель 2] взял книгу 1
[Читатель 2] читает книгу 1 2 дней
[Читатель 2] вернул книгу 1
[Библиотекарь] уведомляю читателя о книге 1
```
Также происходит корректная обработка `SIGINT`:
```
[Читатель 2] хочет прочитать 1 книг(-и)
[Читатель 1] хочет прочитать 2 книг(-и)
[Читатель 1] взял книгу 1
[Читатель 2] взял книгу 0
[Читатель 1] читает книгу 1 2 дней
[Читатель 2] читает книгу 0 2 дней
[Читатель 2] вернул книгу 0
[Читатель 1] вернул книгу 1
[Библиотекарь] уведомляю читателя о книге 0
[Библиотекарь] уведомляю читателя о книге 1
^C
```

---